# เอกสารความต้องการของระบบ - ระบบจองโรงแรมและที่พัก

## บทนำ

ระบบจองโรงแรมและที่พักนี้ถูกออกแบบมาเพื่อแก้ไขปัญหาสำคัญในอุตสาหกรรมการบริการที่ทำให้เกิดการสูญเสียรายได้ ความไม่พอใจของผู้เข้าพัก และความไม่มีประสิทธิภาพในการดำเนินงาน ระบบนี้ถูกออกแบบจากสถานการณ์จริงที่พบในโลกแห่งความเป็นจริง:

### ปัญหาที่พบจริงในอุตสาหกรรม (Real Pain Points)

**ฝั่งผู้เข้าพัก:**
- **การสูญเสียการจอง ณ จุดชำระเงิน:** ผู้ใช้ชำระเงินสำเร็จแล้ว แต่ระบบแจ้งว่าห้องเต็มในภายหลัง เนื่องจากมีคนอื่นจองห้องสุดท้ายพร้อมกัน (Race Condition)
- **การขาดความโปร่งใสของนโยบาย:** ผู้เข้าพักถูกบังคับใช้ข้อกำหนดหรือนโยบายยกเลิกฉบับใหม่ที่ไม่ตรงกับวันที่ทำการจอง
- **การไม่รองรับการเปลี่ยนแปลงการเข้าพัก:** ระบบไม่สามารถรองรับการ "ย้ายห้อง" เมื่อเกิดปัญหา (เช่น แอร์เสีย น้ำไม่ไหล)
- **ความเสี่ยงในการจองซ้ำซ้อน:** เกิดจากการที่ระบบอนุญาตให้ผู้ใช้หลายคนจองห้องสุดท้ายพร้อมกัน

**ฝั่งการปฏิบัติงาน:**
- **การขาดการซิงโครไนซ์ข้อมูลสถานะห้องพัก:** พนักงานต้อนรับไม่เห็นสถานะห้องที่แท้จริงจากแม่บ้าน ทำให้เกิดความสับสนในการจ่ายห้อง
- **ภาระงานในการจัดการราคา:** ผู้จัดการโรงแรมต้องกรอกราคาสำหรับห้องพักทุกประเภทตลอด 365 วัน ซึ่งเป็นภาระงานที่หนักและเสี่ยงต่อความผิดพลาด
- **การทำงานที่ล้มเหลวแบบเงียบ:** ระบบทำงานผิดพลาด (เช่น สต็อกไม่ตัด) แต่ไม่แจ้งเตือนผู้ใช้งาน ทำให้เกิดปัญหาระเบิดเวลาในภายหลัง

### วิธีแก้ปัญหาของระบบนี้

ระบบนี้บังคับใช้ความสมบูรณ์ของข้อมูลผ่าน stored procedures รักษาบันทึกการตรวจสอบที่สมบูรณ์ และให้การซิงโครไนซ์แบบเรียลไทม์ระหว่างทุกแผนก รองรับผู้ใช้งาน 4 บทบาทที่แยกหน้าที่ชัดเจน (Guest, Receptionist, Housekeeper, Hotel Manager) และใช้โมเดลสถานะห้องพักแบบ 2 แกน (การเข้าพัก + การทำความสะอาด) ที่สะท้อนการดำเนินงานโรงแรมจริง

**หลักการออกแบบหลัก:**
- **ความเป็นอะตอม (Atomicity):** การดำเนินการสำคัญทั้งหมดใช้ transactions เพื่อป้องกันข้อมูลไม่สมบูรณ์
- **ความโปร่งใส (Transparency):** บันทึกภาพรวมนโยบาย ณ เวลาที่จอง เพื่อป้องกันการเปลี่ยนแปลงย้อนหลัง
- **ความยืดหยุ่น (Flexibility):** รองรับการย้ายห้องและการแก้ไขการจองอย่างปลอดภัย
- **ความปลอดภัย (Safety):** ป้องกันการจองเกินผ่านข้อจำกัดของสต็อกและ constraint ในฐานข้อมูล
- **ความสามารถในการตรวจสอบ (Auditability):** ประวัติที่สมบูรณ์ของการเปลี่ยนแปลงสถานะทั้งหมด

### ขอบเขตของโครงการ

**ที่อยู่ในขอบเขต:**
- ระบบจองห้องพักแบบออนไลน์สำหรับผู้เข้าพัก
- ระบบจัดการห้องพักและสถานะห้องแบบเรียลไทม์
- ระบบจัดการราคาแบบ dynamic ตามฤดูกาล (Rate Tiers)
- ระบบจัดการการเข้าพัก (Check-in/Check-out/Room Move)
- ระบบจัดการแม่บ้านและการทำความสะอาด
- ระบบรายงานและวิเคราะห์ข้อมูลพื้นฐาน

**ที่อยู่นอกขอบเขต (เพื่อให้โครงการสำเร็จตามกำหนด):**
- ระบบบัญชีและการเงินที่ซับซ้อน (Financial Folios, การแยกบิล, การย้ายหนี้)
- ระบบ Point of Sale (POS) สำหรับร้านอาหารและบริการเสริม
- ระบบจัดการพนักงานและตารางเวลาทำงาน
- ระบบ CRM และ Marketing Automation
- Mobile Application (จะมีเฉพาะ Responsive Web)

## ความต้องการของระบบ

### ความต้องการที่ 1: การลงทะเบียนและจัดการข้อมูลส่วนตัวของผู้เข้าพัก

**User Story:** ในฐานะผู้เข้าพัก ฉันต้องการสร้างบัญชีและจัดการข้อมูลโปรไฟล์ของฉัน เพื่อที่ฉันจะสามารถทำการจองและติดตามประวัติการจองของฉันได้

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้เข้าพักกรอกอีเมล รหัสผ่าน ชื่อ นามสกุล และเบอร์โทรศัพท์ แล้ว ระบบจะต้อง สร้างบัญชีผู้เข้าพักใหม่พร้อมรหัสผ่านที่เข้ารหัสแล้ว (hashed password)
2. หาก อีเมลมีอยู่ในระบบแล้ว แล้ว ระบบจะต้อง ปฏิเสธการลงทะเบียนและแสดงข้อความ "อีเมลนี้ถูกลงทะเบียนแล้ว"
3. เมื่อ ผู้เข้าพักเข้าสู่ระบบด้วยข้อมูลที่ถูกต้อง แล้ว ระบบจะต้อง อัปเดต timestamp ของ LastLogin และอนุญาตให้เข้าถึงแดชบอร์ดของพวกเขา
4. เมื่อ ผู้เข้าพักอัปเดตข้อมูลโปรไฟล์ แล้ว ระบบจะต้อง อัปเดตตาราง Guests และตั้งค่า timestamp ของ UpdatedAt
5. หาก ผู้เข้าพักพยายามใช้รูปแบบอีเมลที่ไม่ถูกต้อง แล้ว ระบบจะต้อง ปฏิเสธข้อมูลก่อนการส่ง (client-side validation)
6. เมื่อ ผู้เข้าพักลืมรหัสผ่าน แล้ว ระบบจะต้อง ส่งลิงก์รีเซ็ตรหัสผ่านไปยังอีเมลที่ลงทะเบียนไว้

### ความต้องการที่ 2: การค้นหาห้องพักและตรวจสอบห้องว่าง

**User Story:** ในฐานะผู้เข้าพัก ฉันต้องการค้นหาห้องว่างตามช่วงวันที่และประเภทห้อง เพื่อที่ฉันจะหาที่พักที่ตรงกับความต้องการของฉันได้

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้เข้าพักกรอกวันเช็คอิน วันเช็คเอาท์ และจำนวนผู้เข้าพัก แล้ว ระบบจะต้อง แสดงประเภทห้องทั้งหมดที่มีห้องว่างสำหรับช่วงวันที่ทั้งหมด
2. หาก ไม่มีห้องว่างสำหรับวันที่เลือก แล้ว ระบบจะต้อง แสดงข้อความ "ไม่มีห้องว่าง" และแนะนำวันที่ทางเลือก (±3 วัน)
3. เมื่อ แสดงประเภทห้อง แล้ว ระบบจะต้อง แสดงชื่อห้อง คำอธิบาย จำนวนผู้เข้าพักสูงสุด สิ่งอำนวยความสะดวก รูปภาพ และราคาต่อคืนสำหรับแต่ละวันที่
4. เมื่อ คำนวณห้องว่าง แล้ว ระบบจะต้อง สอบถาม RoomInventory โดยที่ (Allotment - BookedCount - TentativeCount) > 0 สำหรับทุกวันในช่วงที่เลือก
5. หาก วันเช็คเอาท์ไม่ได้อยู่หลังวันเช็คอิน แล้ว ระบบจะต้อง ปฏิเสธการค้นหาพร้อมข้อผิดพลาดการตรวจสอบ
6. เมื่อ แสดงราคา แล้ว ระบบจะต้อง คำนวณต้นทุนรวมโดยรวมอัตราค่าห้องรายคืนจาก RatePricing ตาม tier ที่กำหนดใน PricingCalendar
7. หาก ประเภทห้องมีราคาที่แตกต่างกันในช่วงวันที่ แล้ว ระบบจะต้อง แสดงรายละเอียดราคาต่อคืนแยกตามวัน
8. เมื่อ ผู้เข้าพักเลือกจำนวนผู้เข้าพักที่มากกว่า MaxOccupancy ของห้อง แล้ว ระบบจะต้อง ซ่อนห้องนั้นจากผลการค้นหา

### ความต้องการที่ 3: การจองห้องแบบชั่วคราว (Booking Hold)

**User Story:** ในฐานะผู้เข้าพัก ฉันต้องการจองห้องไว้ชั่วคราวขณะที่ฉันกรอกข้อมูลและชำระเงิน เพื่อที่ห้องจะไม่ถูกคนอื่นจองไปในระหว่างนั้น

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้เข้าพักเลือกห้องและกดปุ่ม "จองห้องนี้" แล้ว ระบบจะต้อง เรียก SP_CreateBookingHold เพื่อสำรองสต็อก
2. เมื่อ SP_CreateBookingHold ทำงาน แล้ว ระบบจะต้อง อัปเดต RoomInventory SET TentativeCount = TentativeCount + 1 แบบ atomic สำหรับทุกวันในช่วงการจอง
3. หาก TentativeCount + BookedCount จะเกิน Allotment แล้ว ระบบจะต้อง rollback transaction และแสดงข้อความ "ห้องไม่ว่างแล้ว กรุณาเลือกห้องอื่น"
4. เมื่อ สร้าง booking hold แล้ว ระบบจะต้อง ตั้งค่า HoldExpiry เป็น 15 นาทีจากเวลาปัจจุบัน
5. เมื่อ เวลา HoldExpiry หมด แล้ว background job จะต้อง เรียก SP_ReleaseExpiredHolds เพื่อลด TentativeCount
6. เมื่อ สร้าง booking hold แล้ว ระบบจะต้อง บันทึกข้อมูลใน BookingHolds พร้อม SessionID สำหรับการติดตาม
7. หาก ผู้เข้าพักมี hold ที่ active อยู่แล้วสำหรับวันที่เดียวกัน แล้ว ระบบจะต้อง ปล่อย hold เก่าก่อนสร้าง hold ใหม่
8. เมื่อ แสดงหน้าชำระเงิน แล้ว ระบบจะต้อง แสดงตัวนับเวลาถอยหลังที่เหลืออยู่ให้ผู้ใช้เห็น

### ความต้องการที่ 4: การชำระเงินและยืนยันการจอง

**User Story:** ในฐานะผู้เข้าพัก ฉันต้องการชำระเงินอย่างปลอดภัยและได้รับการยืนยันการจองทันที เพื่อที่ฉันจะมั่นใจว่ามีที่พักแน่นอน

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้เข้าพักชำระเงินสำเร็จ แล้ว ระบบจะต้อง เรียก SP_ConfirmBooking ภายใน transaction เดียวกัน
2. เมื่อ SP_ConfirmBooking ทำงาน แล้ว ระบบจะต้อง อัปเดต Bookings.Status = 'Confirmed', RoomInventory SET BookedCount = BookedCount + 1 AND TentativeCount = TentativeCount - 1 แบบ atomic
3. เมื่อ การจองได้รับการยืนยัน แล้ว ระบบจะต้อง บันทึกภาพรวมของนโยบายการยกเลิก (PolicyName, PolicyDescription) ลงในตาราง Bookings
4. เมื่อ การจองได้รับการยืนยัน แล้ว ระบบจะต้อง บันทึกข้อมูลใน BookingNightlyLog พร้อม QuotedPrice สำหรับทุกคืน
5. หาก การชำระเงินล้มเหลว แล้ว ระบบจะต้อง ไม่เรียก SP_ConfirmBooking และปล่อยให้ hold หมดอายุตามปกติ
6. เมื่อ การจองได้รับการยืนยัน แล้ว ระบบจะต้อง ส่งอีเมลยืนยันพร้อมหมายเลขการจอง วันที่ ประเภทห้อง ยอดรวม และนโยบายการยกเลิก
7. เมื่อ คำนวณ TotalAmount แล้ว ระบบจะต้อง นำส่วนลดจากคูปองมาคำนวณ (ถ้ามี) และตรวจสอบว่าคูปองไม่หมดอายุและยังไม่เกิน MaxUses
8. หาก มีการใช้คูปอง แล้ว ระบบจะต้อง เพิ่ม Vouchers.CurrentUses แบบ atomic
9. เมื่อ แสดงหน้ายืนยันการชำระเงิน แล้ว ระบบจะต้อง แสดงรายละเอียดการจองทั้งหมด รวมถึงนโยบายการยกเลิกอย่างชัดเจน

### ความต้องการที่ 5: การดูประวัติและรายละเอียดการจอง

**User Story:** ในฐานะผู้เข้าพัก ฉันต้องการดูประวัติการจองและรายละเอียดของแต่ละการจอง เพื่อที่ฉันจะติดตามการเข้าพักและอ้างอิงการจองในอดีตได้

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้เข้าพักเข้าถึงหน้าประวัติการจอง แล้ว ระบบจะต้อง แสดงการจองทั้งหมดเรียงตาม CreatedAt จากใหม่ไปเก่า
2. เมื่อ แสดงแต่ละการจอง แล้ว ระบบจะต้อง แสดง BookingID, สถานะ, วันเช็คอิน, วันเช็คเอาท์, ประเภทห้อง, ยอดรวม และ PolicyName ที่บันทึกไว้
3. เมื่อ ผู้เข้าพักคลิกที่การจอง แล้ว ระบบจะต้อง แสดงรายละเอียดเต็มรูปแบบ รวมถึง BookingGuests, หมายเลขห้อง (ถ้าเช็คอินแล้ว) และรายละเอียดจาก BookingNightlyLog
4. หาก การจองมีสถานะ 'Confirmed' หรือ 'CheckedIn' แล้ว ระบบจะต้อง แสดงนโยบายการยกเลิกที่มีผลบังคับใช้ ณ เวลาที่จอง
5. เมื่อ แสดงประวัติการจอง แล้ว ระบบจะต้อง ให้ผู้ใช้กรองตามสถานะได้ (เช่น "แสดงเฉพาะการจองที่กำลังจะมาถึง")
6. เมื่อ แสดงรายละเอียดการจอง แล้ว ระบบจะต้อง แสดงปุ่ม "ยกเลิกการจอง" สำหรับการจองที่สามารถยกเลิกได้
7. เมื่อ แสดงรายละเอียดการจอง แล้ว ระบบจะต้อง แสดงปุ่ม "ดาวน์โหลดใบเสร็จ" สำหรับการจองที่เสร็จสมบูรณ์

### ความต้องการที่ 6: การยกเลิกการจอง

**User Story:** ในฐานะผู้เข้าพัก ฉันต้องการยกเลิกการจองและเข้าใจจำนวนเงินคืนที่จะได้รับ เพื่อที่ฉันจะจัดการกับการเปลี่ยนแปลงแผนการเดินทางได้

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้เข้าพักขอยกเลิกการจองที่มีสถานะ 'Confirmed' แล้ว ระบบจะต้อง เรียก SP_CancelConfirmedBooking
2. เมื่อ SP_CancelConfirmedBooking ทำงาน แล้ว ระบบจะต้อง อัปเดต Bookings.Status = 'Cancelled' AND RoomInventory SET BookedCount = BookedCount - 1 แบบ atomic สำหรับทุกวัน
3. เมื่อ ผู้เข้าพักขอยกเลิกการจองที่มีสถานะ 'PendingPayment' แล้ว ระบบจะต้อง เรียก SP_CancelPendingBooking
4. เมื่อ SP_CancelPendingBooking ทำงาน แล้ว ระบบจะต้อง อัปเดต Bookings.Status = 'Cancelled' AND RoomInventory SET TentativeCount = TentativeCount - 1 แบบ atomic
5. เมื่อ คำนวณจำนวนเงินคืน แล้ว ระบบจะต้อง ใช้นโยบายการยกเลิกที่บันทึกไว้ในตาราง Bookings (ไม่ใช่นโยบายปัจจุบัน)
6. หาก การยกเลิกอยู่ภายในระยะเวลา DaysBeforeCheckIn ที่กำหนด แล้ว ระบบจะต้อง คำนวณเงินคืนเป็น TotalAmount * (RefundPercentage / 100)
7. เมื่อ การจองถูกยกเลิก แล้ว ระบบจะต้อง ส่งอีเมลยืนยันการยกเลิกพร้อมจำนวนเงินคืนและระยะเวลาการประมวลผล
8. หาก การจองมีสถานะ 'CheckedIn' หรือ 'Completed' แล้ว ระบบจะต้อง ปฏิเสธคำขอยกเลิก
9. เมื่อ ผู้เข้าพักกดปุ่มยกเลิก แล้ว ระบบจะต้อง แสดงหน้าต่างยืนยันพร้อมแสดงจำนวนเงินคืนที่จะได้รับก่อนดำเนินการ


### ความต้องการที่ 7: กระบวนการเช็คอิน

**User Story:** ในฐานะพนักงานต้อนรับ ฉันต้องการทำการเช็คอินให้แขกและจัดห้องที่สะอาดให้ เพื่อที่แขกจะเริ่มการเข้าพักได้อย่างราบรื่น

#### เกณฑ์การยอมรับ

1. เมื่อ พนักงานต้อนรับเริ่มกระบวนการเช็คอินสำหรับการจอง แล้ว ระบบจะต้อง แสดงห้องทั้งหมดของ RoomType ที่จองพร้อมสถานะ OccupancyStatus และ HousekeepingStatus ปัจจุบัน
2. เมื่อ พนักงานต้อนรับเลือกห้องสำหรับเช็คอิน แล้ว ระบบจะต้อง เรียก SP_CheckIn พร้อม BookingDetailID และ RoomID
3. เมื่อ SP_CheckIn ทำงาน แล้ว ระบบจะต้อง ตรวจสอบว่า OccupancyStatus = 'Vacant' AND HousekeepingStatus IN ('Clean', 'Inspected')
4. หาก การตรวจสอบล้มเหลว แล้ว ระบบจะต้อง rollback และแสดงข้อความ "ห้องยังไม่พร้อมสำหรับเช็คอิน"
5. เมื่อ การตรวจสอบของ SP_CheckIn ผ่าน แล้ว ระบบจะต้อง อัปเดต Bookings.Status = 'CheckedIn', INSERT RoomAssignments พร้อม Status = 'Active', UPDATE Rooms.OccupancyStatus = 'Occupied' แบบ atomic
6. เมื่อ เช็คอินเสร็จสมบูรณ์ แล้ว ระบบจะต้อง แสดงข้อมูลกุญแจห้องและข้อความต้อนรับแขก
7. หาก การจองมีหลาย BookingDetails (หลายห้อง) แล้ว ระบบจะต้อง ให้ทำการเช็คอินแยกสำหรับแต่ละห้อง
8. เมื่อ แสดงรายการห้องที่พร้อมเช็คอิน แล้ว ระบบจะต้อง แสดงห้องที่มีสถานะ 'Inspected' ก่อนห้องที่มีสถานะ 'Clean'

### ความต้องการที่ 8: การย้ายห้องระหว่างการเข้าพัก

**User Story:** ในฐานะพนักงานต้อนรับ ฉันต้องการย้ายแขกไปห้องอื่นระหว่างการเข้าพัก เพื่อที่ฉันจะแก้ไขปัญหาเช่นปัญหาการซ่อมบำรุงหรือข้อร้องเรียนของแขกได้

#### เกณฑ์การยอมรับ

1. เมื่อ พนักงานต้อนรับเริ่มกระบวนการย้ายห้อง แล้ว ระบบจะต้อง แสดงห้องว่างทั้งหมดของ RoomType เดียวกันหรือสูงกว่า
2. เมื่อ พนักงานต้อนรับยืนยันการย้ายห้อง แล้ว ระบบจะต้อง เรียก SP_MoveRoom พร้อม RoomAssignmentID ปัจจุบันและ RoomID ใหม่
3. เมื่อ SP_MoveRoom ทำงาน แล้ว ระบบจะต้อง อัปเดต RoomAssignment เก่า SET Status = 'Moved' AND CheckOutDateTime = NOW(), INSERT RoomAssignment ใหม่พร้อม Status = 'Active' แบบ atomic
4. เมื่อ SP_MoveRoom ทำงาน แล้ว ระบบจะต้อง อัปเดตห้องเก่า SET OccupancyStatus = 'Vacant' AND HousekeepingStatus = 'Dirty', อัปเดตห้องใหม่ SET OccupancyStatus = 'Occupied'
5. เมื่อ การย้ายห้องเสร็จสมบูรณ์ แล้ว ระบบจะต้อง รักษาบันทึกการตรวจสอบที่สมบูรณ์แสดง RoomAssignment ทั้งสองห้อง
6. หาก ห้องใหม่ไม่ว่างหรือไม่สะอาด แล้ว ระบบจะต้อง ปฏิเสธการย้ายห้อง
7. เมื่อ ย้ายห้องสำเร็จ แล้ว ระบบจะต้อง บันทึก log พร้อมเหตุผลในการย้าย (ถ้ามี) และแจ้งเตือนแผนกแม่บ้านให้ทำความสะอาดห้องเก่า

### ความต้องการที่ 9: กระบวนการเช็คเอาท์

**User Story:** ในฐานะพนักงานต้อนรับ ฉันต้องการทำการเช็คเอาท์ให้แขกและสรุปการเข้าพัก เพื่อที่ห้องจะสามารถเตรียมพร้อมสำหรับแขกคนต่อไปได้

#### เกณฑ์การยอมรับ

1. เมื่อ พนักงานต้อนรับเริ่มกระบวนการเช็คเอาท์สำหรับการจอง แล้ว ระบบจะต้อง เรียก SP_CheckOut พร้อม BookingID
2. เมื่อ SP_CheckOut ทำงาน แล้ว ระบบจะต้อง อัปเดต Bookings.Status = 'Completed', อัปเดต RoomAssignments ที่ active ทั้งหมด SET Status = 'Completed' AND CheckOutDateTime = NOW() แบบ atomic
3. เมื่อ SP_CheckOut ทำงาน แล้ว ระบบจะต้อง อัปเดตห้องที่ถูกจัดสรรทั้งหมด SET OccupancyStatus = 'Vacant' AND HousekeepingStatus = 'Dirty'
4. เมื่อ เช็คเอาท์เสร็จสมบูรณ์ แล้ว ระบบจะต้อง แสดงสรุปบิลพร้อม TotalAmount จากการจอง
5. หาก การจองมีสถานะ != 'CheckedIn' แล้ว ระบบจะต้อง ปฏิเสธคำขอเช็คเอาท์
6. เมื่อ เช็คเอาท์เสร็จสมบูรณ์ แล้ว ระบบจะต้อง ส่งอีเมลใบเสร็จให้แขก
7. เมื่อ เช็คเอาท์เสร็จสมบูรณ์ แล้ว ระบบจะต้อง แจ้งเตือนแผนกแม่บ้านให้ทำความสะอาดห้องที่เช็คเอาท์

### ความต้องการที่ 10: การจัดการสถานะการทำความสะอาดห้อง

**User Story:** ในฐานะแม่บ้าน ฉันต้องการอัปเดตสถานะการทำความสะอาดห้องแบบเรียลไทม์ เพื่อที่แผนกต้อนรับจะรู้ว่าห้องไหนพร้อมสำหรับแขก

#### เกณฑ์การยอมรับ

1. เมื่อ แม่บ้านดูรายการงาน แล้ว ระบบจะต้อง แสดงห้องทั้งหมดที่ HousekeepingStatus IN ('Dirty', 'Cleaning') เรียงตามลำดับความสำคัญ
2. เมื่อ แม่บ้านเริ่มทำความสะอาดห้อง แล้ว ระบบจะต้อง อัปเดต Rooms SET HousekeepingStatus = 'Cleaning'
3. เมื่อ แม่บ้านทำความสะอาดเสร็จ แล้ว ระบบจะต้อง อัปเดต Rooms SET HousekeepingStatus = 'Clean'
4. หาก แม่บ้านพบปัญหาการซ่อมบำรุง แล้ว ระบบจะต้อง อัปเดต Rooms SET HousekeepingStatus = 'MaintenanceRequired' และสร้างใบแจ้งซ่อม
5. เมื่อ สถานะการทำความสะอาดเปลี่ยนแปลง แล้ว ระบบจะต้อง สะท้อนการเปลี่ยนแปลงทันทีในแดชบอร์ดสถานะห้องของพนักงานต้อนรับ
6. เมื่อ แม่บ้านทำเครื่องหมายห้องเป็น 'Clean' แล้ว ระบบจะต้อง บันทึก timestamp เพื่อการตรวจสอบ
7. เมื่อ แสดงรายการงาน แล้ว ระบบจะต้อง แสดงเวลาโดยประมาณที่ใช้ในการทำความสะอาดแต่ละห้อง (ตาม RoomType)

### ความต้องการที่ 11: การตรวจสอบห้องโดยหัวหน้าแม่บ้าน

**User Story:** ในฐานะหัวหน้าแม่บ้าน ฉันต้องการตรวจสอบและอนุมัติห้องที่ทำความสะอาดแล้ว เพื่อที่เราจะรักษามาตรฐานคุณภาพก่อนแขกเช็คอิน

#### เกณฑ์การยอมรับ

1. เมื่อ หัวหน้าแม่บ้านดูคิวการตรวจสอบ แล้ว ระบบจะต้อง แสดงห้องทั้งหมดที่ HousekeepingStatus = 'Clean'
2. เมื่อ หัวหน้าแม่บ้านอนุมัติห้อง แล้ว ระบบจะต้อง อัปเดต Rooms SET HousekeepingStatus = 'Inspected'
3. หาก หัวหน้าแม่บ้านปฏิเสธห้อง แล้ว ระบบจะต้อง อัปเดต Rooms SET HousekeepingStatus = 'Dirty' และแจ้งเตือนแม่บ้านที่รับผิดชอบ
4. เมื่อ ห้องถูกทำเครื่องหมายเป็น 'Inspected' แล้ว ระบบจะต้อง จัดลำดับความสำคัญสำหรับการจัดสรรเช็คอิน
5. เมื่อ แสดงห้องสำหรับเช็คอิน แล้ว ระบบจะต้อง แสดงห้อง 'Inspected' ก่อนห้อง 'Clean'
6. เมื่อ หัวหน้าแม่บ้านปฏิเสธห้อง แล้ว ระบบจะต้อง ให้กรอกเหตุผลและบันทึกไว้เพื่อการปรับปรุง

### ความต้องการที่ 12: แดชบอร์ดสถานะห้องพัก

**User Story:** ในฐานะพนักงานต้อนรับ ฉันต้องการดูแดชบอร์ดสถานะห้องแบบเรียลไทม์ เพื่อที่ฉันจะระบุห้องว่างและปัญหาการดำเนินงานได้อย่างรวดเร็ว

#### เกณฑ์การยอมรับ

1. เมื่อ พนักงานต้อนรับเข้าถึงแดชบอร์ด แล้ว ระบบจะต้อง แสดงตารางห้องทั้งหมดพร้อม OccupancyStatus และ HousekeepingStatus
2. เมื่อ แสดงแดชบอร์ด แล้ว ระบบจะต้อง ใช้รหัสสี: เขียว = (Vacant + Inspected), เหลือง = (Vacant + Clean), แดง = (Occupied), เทา = (OutOfService)
3. เมื่อ พนักงานต้อนรับกรองตามสถานะ แล้ว ระบบจะต้อง อัปเดตการแสดงผลแบบเรียลไทม์
4. เมื่อ แสดงแต่ละห้อง แล้ว ระบบจะต้อง แสดงหมายเลขห้อง ประเภทห้อง ชื่อแขกปัจจุบัน (ถ้ามีผู้เข้าพัก) และวันเช็คเอาท์ที่คาดหวัง
5. เมื่อ แดชบอร์ดโหลด แล้ว ระบบจะต้อง รีเฟรชอัตโนมัติทุก 30 วินาที
6. หาก ห้องมี HousekeepingStatus = 'MaintenanceRequired' แล้ว ระบบจะต้อง แสดงไอคอนเตือน
7. เมื่อ แสดงแดชบอร์ด แล้ว ระบบจะต้อง แสดงสรุปจำนวนห้องแยกตามสถานะที่ด้านบน

### ความต้องการที่ 13: การจัดการสต็อกห้องพัก (Inventory Management)

**User Story:** ในฐานะผู้จัดการโรงแรม ฉันต้องการตั้งค่าจำนวนห้องที่เปิดขายสำหรับวันที่ในอนาคต เพื่อที่ฉันจะควบคุมห้องว่างและป้องกันการจองเกินได้

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้จัดการเข้าถึงการจัดการสต็อก แล้ว ระบบจะต้อง แสดง RoomInventory สำหรับ RoomType ทั้งหมดสำหรับ 365 วันข้างหน้า
2. เมื่อ ผู้จัดการอัปเดต Allotment สำหรับวันที่เฉพาะ แล้ว ระบบจะต้อง ตรวจสอบว่า Allotment >= (BookedCount + TentativeCount)
3. หาก การตรวจสอบล้มเหลว แล้ว ระบบจะต้อง ปฏิเสธการอัปเดตและแสดง "ไม่สามารถลดจำนวนห้องต่ำกว่าการจองปัจจุบันได้"
4. เมื่อ ผู้จัดการตั้งค่า Allotment แล้ว ระบบจะต้อง INSERT หรือ UPDATE RoomInventory สำหรับ RoomType และ Date ที่ระบุ
5. เมื่อ แสดงสต็อก แล้ว ระบบจะต้อง แสดง Allotment, BookedCount, TentativeCount และ Available (คำนวณ) สำหรับแต่ละวัน
6. เมื่อ ผู้จัดการอัปเดต allotment แบบกลุ่มสำหรับช่วงวันที่ แล้ว ระบบจะต้อง ใช้การเปลี่ยนแปลงกับทุกวันในช่วงนั้น
7. เมื่อ แสดงหน้าจัดการสต็อก แล้ว ระบบจะต้อง แสดงปฏิทินแบบ heatmap ที่แสดงระดับการจองด้วยสี (เขียว = ว่างมาก, แดง = เกือบเต็ม)

### ความต้องการที่ 14: ระดับราคาและปฏิทินราคา (Rate Tier & Pricing Calendar)

**User Story:** ในฐานะผู้จัดการโรงแรม ฉันต้องการกำหนดระดับราคา (เช่น ฤดูต่ำ ฤดูสูง) และกำหนดให้กับวันที่ เพื่อที่ราคาจะปรับอัตโนมัติตามอุปสงค์

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้จัดการสร้างระดับราคา แล้ว ระบบจะต้อง INSERT ลงใน RateTiers พร้อม Name ที่ไม่ซ้ำ
2. เมื่อ ผู้จัดการกำหนดระดับราคาให้กับวันที่ แล้ว ระบบจะต้อง INSERT หรือ UPDATE PricingCalendar พร้อม RateTierID
3. เมื่อ แสดงปฏิทินราคา แล้ว ระบบจะต้อง แสดงมุมมองรายปีพร้อมระดับที่มีรหัสสี
4. เมื่อ ผู้จัดการกำหนดระดับแบบกลุ่มให้กับช่วงวันที่ แล้ว ระบบจะต้อง อัปเดตทุกวันในช่วงนั้น
5. หาก วันที่ไม่มีระดับที่กำหนด แล้ว ระบบจะต้อง ใช้ระดับเริ่มต้น (เช่น "Standard")
6. เมื่อ ระดับราคาถูกลบ แล้ว ระบบจะต้อง ป้องกันการลบถ้ามีการอ้างอิงใน PricingCalendar
7. เมื่อ แสดงปฏิทินราคา แล้ว ระบบจะต้อง ให้ผู้จัดการคัดลอกการตั้งค่าจากปีก่อนหน้าได้


### ความต้องการที่ 15: แผนราคาและการกำหนดค่าราคา (Rate Plan & Pricing Configuration)

**User Story:** ในฐานะผู้จัดการโรงแรม ฉันต้องการตั้งราคาสำหรับแต่ละชุดของแผนราคา ประเภทห้อง และระดับราคา เพื่อที่ระบบจะคำนวณต้นทุนการจองได้อย่างถูกต้อง

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้จัดการสร้างแผนราคา แล้ว ระบบจะต้อง INSERT ลงใน RatePlans พร้อม Name, Description และ PolicyID ที่เกี่ยวข้อง
2. เมื่อ ผู้จัดการตั้งราคา แล้ว ระบบจะต้อง INSERT หรือ UPDATE RatePricing สำหรับชุดของ RatePlanID, RoomTypeID และ RateTierID
3. เมื่อ ผู้เข้าพักค้นหาห้อง แล้ว ระบบจะต้อง คำนวณราคารายคืนโดย join BookingDetails.RatePlanID, BookingDetails.RoomTypeID, PricingCalendar.RateTierID และ RatePricing.Price
4. หาก ไม่มีราคาที่กำหนดค่าสำหรับชุดเฉพาะ แล้ว ระบบจะต้อง แสดง "ราคาไม่พร้อมใช้งาน" และป้องกันการจอง
5. เมื่อ ผู้จัดการดูเมทริกซ์ราคา แล้ว ระบบจะต้อง แสดงตารางที่มี RoomTypes เป็นแถวและ RateTiers เป็นคอลัมน์
6. เมื่อ ผู้จัดการอัปเดตราคาแบบกลุ่ม แล้ว ระบบจะต้อง ใช้เปอร์เซ็นต์เพิ่ม/ลดกับชุดที่เลือก
7. เมื่อ แสดงเมทริกซ์ราคา แล้ว ระบบจะต้อง เน้นเซลล์ที่ยังไม่มีการตั้งราคาด้วยสีแดง

### ความต้องการที่ 16: การจัดการนโยบายการยกเลิก

**User Story:** ในฐานะผู้จัดการโรงแรม ฉันต้องการกำหนดนโยบายการยกเลิกพร้อมกฎการคืนเงิน เพื่อที่แขกจะเข้าใจเงื่อนไขก่อนการจอง

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้จัดการสร้างนโยบายการยกเลิก แล้ว ระบบจะต้อง INSERT ลงใน CancellationPolicies พร้อม Name, Description, DaysBeforeCheckIn และ RefundPercentage
2. เมื่อ ผู้จัดการเชื่อมโยงนโยบายกับแผนราคา แล้ว ระบบจะต้อง UPDATE RatePlans SET PolicyID
3. เมื่อ ผู้เข้าพักดูแผนราคา แล้ว ระบบจะต้อง แสดงนโยบายการยกเลิกที่เกี่ยวข้องอย่างชัดเจน
4. เมื่อ การจองถูกสร้าง แล้ว ระบบจะต้อง บันทึกภาพรวม PolicyName และ PolicyDescription ลงในตาราง Bookings
5. หาก ผู้จัดการอัปเดตนโยบาย แล้ว ระบบจะต้อง ไม่ส่งผลกระทบต่อการจองที่มีอยู่ (เนื่องจากการบันทึกภาพรวม)
6. เมื่อ คำนวณเงินคืน แล้ว ระบบจะต้อง ใช้นโยบายที่บันทึกไว้จากการจอง ไม่ใช่นโยบายปัจจุบัน
7. เมื่อ แสดงนโยบายการยกเลิก แล้ว ระบบจะต้อง แสดงตัวอย่างการคำนวณเงินคืนสำหรับสถานการณ์ต่างๆ

### ความต้องการที่ 17: การจัดการคูปองและส่วนลด

**User Story:** ในฐานะผู้จัดการโรงแรม ฉันต้องการสร้างคูปองส่งเสริมการขายพร้อมขอบเขตการใช้งาน เพื่อที่ฉันจะเปิดแคมเปญการตลาดและติดตามการใช้งานได้

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้จัดการสร้างคูปอง แล้ว ระบบจะต้อง INSERT ลงใน Vouchers พร้อม Code, DiscountType, DiscountValue, ExpiryDate และ MaxUses
2. เมื่อ ผู้เข้าพักใช้รหัสคูปอง แล้ว ระบบจะต้อง ตรวจสอบว่า Code มีอยู่, ExpiryDate >= วันนี้ และ CurrentUses < MaxUses
3. หาก การตรวจสอบล้มเหลว แล้ว ระบบจะต้อง แสดงข้อความแสดงข้อผิดพลาดที่เหมาะสม ("รหัสไม่ถูกต้อง", "หมดอายุ" หรือ "ถึงขีดจำกัดการใช้งาน")
4. เมื่อ การจองได้รับการยืนยันพร้อมคูปอง แล้ว ระบบจะต้อง อัปเดต Vouchers SET CurrentUses = CurrentUses + 1 แบบ atomic
5. เมื่อ คำนวณส่วนลด แล้ว ระบบจะต้อง ใช้ DiscountType: ถ้า 'Percentage' แล้ว TotalAmount * (DiscountValue / 100), ถ้า 'FixedAmount' แล้ว DiscountValue
6. เมื่อ แสดงสรุปการจอง แล้ว ระบบจะต้อง แสดงยอดเดิม ยอดส่วนลด และยอดสุทธิแยกกัน
7. เมื่อ ผู้จัดการดูรายงานคูปอง แล้ว ระบบจะต้อง แสดงจำนวนการใช้งาน มูลค่าส่วนลดรวม และอัตราการแปลง

### ความต้องการที่ 18: กระบวนการตรวจสอบกลางคืน (Night Audit)

**User Story:** ในฐานะผู้ดูแลระบบ ฉันต้องการกระบวนการตรวจสอบกลางคืนอัตโนมัติที่ทำงานทุกวัน เพื่อที่สถานะห้องจะถูกรีเซ็ตและข้อมูลการดำเนินงานจะสอดคล้องกัน

#### เกณฑ์การยอมรับ

1. เมื่อ การตรวจสอบกลางคืนทำงาน (กำหนดเวลาที่ 02:00 น. ทุกวัน) แล้ว ระบบจะต้อง เรียก SP_RunNightAudit
2. เมื่อ SP_RunNightAudit ทำงาน แล้ว ระบบจะต้อง อัปเดต Rooms SET HousekeepingStatus = 'Dirty' WHERE OccupancyStatus = 'Occupied'
3. เมื่อ การตรวจสอบกลางคืนเสร็จสมบูรณ์ แล้ว ระบบจะต้อง บันทึกเวลาการทำงานและจำนวนห้องที่อัปเดต
4. หาก การตรวจสอบกลางคืนล้มเหลว แล้ว ระบบจะต้อง ส่งอีเมลแจ้งเตือนไปยังผู้ดูแลระบบ
5. เมื่อ การตรวจสอบกลางคืนทำงาน แล้ว ระบบจะต้อง เรียก SP_ReleaseExpiredHolds เพื่อล้างข้อมูล booking holds ที่หมดอายุ
6. เมื่อ การตรวจสอบกลางคืนทำงาน แล้ว ระบบจะต้อง สร้างรายงานสรุปประจำวันสำหรับผู้จัดการ

### ความต้องการที่ 19: รายงานและการวิเคราะห์ข้อมูล

**User Story:** ในฐานะผู้จัดการโรงแรม ฉันต้องการดูรายงานการเข้าพักและการวิเคราะห์รายได้ เพื่อที่ฉันจะตัดสินใจทางธุรกิจอย่างมีข้อมูล

#### เกณฑ์การยอมรับ

1. เมื่อ ผู้จัดการขอรายงานการเข้าพัก แล้ว ระบบจะต้อง คำนวณอัตราการเข้าพักเป็น (BookedCount / Allotment) * 100 สำหรับแต่ละวัน
2. เมื่อ แสดงรายงานการเข้าพัก แล้ว ระบบจะต้อง แสดงมุมมองรายวัน รายสัปดาห์ และรายเดือนพร้อมกราฟแนวโน้ม
3. เมื่อ ผู้จัดการขอรายงานรายได้ แล้ว ระบบจะต้อง รวม TotalAmount จาก Bookings WHERE Status IN ('Confirmed', 'CheckedIn', 'Completed') จัดกลุ่มตามช่วงวันที่
4. เมื่อ แสดงรายงานรายได้ แล้ว ระบบจะต้อง แยกตาม RoomType และ RatePlan
5. เมื่อ ผู้จัดการส่งออกรายงาน แล้ว ระบบจะต้อง สร้างรูปแบบ CSV หรือ PDF
6. เมื่อ คำนวณอัตราค่าห้องเฉลี่ยต่อวัน (ADR) แล้ว ระบบจะต้อง คำนวณ SUM(TotalAmount) / SUM(NumberOfNights) สำหรับช่วงเวลาที่เลือก
7. เมื่อ แสดงรายงาน แล้ว ระบบจะต้อง แสดงการเปรียบเทียบกับช่วงเวลาเดียวกันของปีก่อนหน้า

### ความต้องการที่ 20: การจัดการกรณีไม่มาเช็คอิน (No-Show Handling)

**User Story:** ในฐานะพนักงานต้อนรับ ฉันต้องการทำเครื่องหมายการจองเป็น no-show เมื่อแขกไม่มา เพื่อที่ห้องจะสามารถปล่อยได้และเรียกเก็บค่าใช้จ่ายที่เหมาะสม

#### เกณฑ์การยอมรับ

1. เมื่อ แขกไม่เช็คอินภายในสิ้นวันเช็คอิน แล้ว ระบบจะต้อง อนุญาตให้พนักงานต้อนรับทำเครื่องหมายการจองเป็น 'NoShow'
2. เมื่อ การจองถูกทำเครื่องหมายเป็น 'NoShow' แล้ว ระบบจะต้อง อัปเดต Bookings.Status = 'NoShow'
3. เมื่อ การจองกลายเป็น 'NoShow' แล้ว ระบบจะต้อง ไม่ปล่อยสต็อกอัตโนมัติ (เป็นการตัดสินใจของผู้จัดการ)
4. เมื่อ แสดงการจอง no-show แล้ว ระบบจะต้อง แสดงข้อมูลติดต่อแขกสำหรับการติดตาม
5. หาก แขก no-show มาถึงสาย แล้ว พนักงานต้อนรับจะต้อง สามารถเปลี่ยนสถานะกลับเป็น 'Confirmed' และดำเนินการเช็คอินได้
6. เมื่อ การจองถูกทำเครื่องหมายเป็น 'NoShow' แล้ว ระบบจะต้อง คำนวณค่าปรับตามนโยบายและบันทึกไว้
7. เมื่อ แสดงรายงาน no-show แล้ว ระบบจะต้อง แสดงแนวโน้มและรูปแบบเพื่อช่วยลดอัตรา no-show

## สรุปผู้ใช้งานระบบและ Use Cases

ระบบถูกออกแบบมาเพื่อรองรับผู้ใช้งาน 4 กลุ่มหลัก:

### 1. ผู้เข้าพัก (Guest)
- ลงทะเบียนและจัดการโปรไฟล์
- ค้นหาและจองห้องพัก
- ดูประวัติการจองและยกเลิกการจอง
- ใช้คูปองส่วนลด

### 2. พนักงานต้อนรับ (Receptionist)
- จัดการการจอง (CRUD)
- ทำการเช็คอิน/เช็คเอาท์
- ย้ายห้องระหว่างการเข้าพัก
- ดูแดชบอร์ดสถานะห้องแบบเรียลไทม์
- จัดการกรณี no-show
- จัดการข้อมูลโปรไฟล์ของแขก

### 3. แม่บ้าน (Housekeeper)
- ดูรายการงานทำความสะอาด
- อัปเดตสถานะการทำความสะอาดห้อง
- รายงานปัญหาการซ่อมบำรุง
- ตรวจสอบและอนุมัติห้องที่ทำความสะอาดแล้ว (สำหรับหัวหน้าแม่บ้าน)

### 4. ผู้จัดการโรงแรม (Hotel Manager)
- จัดการข้อมูลหลัก (ประเภทห้อง, สิ่งอำนวยความสะดวก)
- กำหนดราคาและระดับราคา
- จัดการสต็อกห้องพัก
- สร้างและจัดการนโยบายการยกเลิก
- สร้างและจัดการคูปอง
- ดูรายงานและการวิเคราะห์
- กำหนดค่าการตรวจสอบกลางคืน (Night Audit)

## หมายเหตุสำคัญสำหรับการพัฒนา

### ความปลอดภัยของข้อมูล (Data Integrity)
- ใช้ Stored Procedures สำหรับการดำเนินการที่สำคัญทั้งหมด
- ใช้ Transactions เพื่อรับประกัน Atomicity
- ใช้ Constraints ในฐานข้อมูลเพื่อป้องกันข้อมูลไม่ถูกต้อง
- ใช้ Optimistic Locking หรือ Pessimistic Locking ตามความเหมาะสม

### ประสิทธิภาพ (Performance)
- สร้าง Index ที่เหมาะสมสำหรับ query ที่ใช้บ่อย
- ใช้ Caching สำหรับข้อมูลที่ไม่เปลี่ยนแปลงบ่อย
- ใช้ Connection Pooling
- ใช้ Pagination สำหรับรายการที่มีข้อมูลมาก

### ความปลอดภัย (Security)
- เข้ารหัสรหัสผ่านด้วย bcrypt หรือ argon2
- ใช้ HTTPS สำหรับการสื่อสารทั้งหมด
- ป้องกัน SQL Injection ด้วย Prepared Statements
- ป้องกัน XSS และ CSRF
- ใช้ JWT หรือ Session สำหรับ Authentication

### การทดสอบ (Testing)
- Unit Tests สำหรับ Business Logic
- Integration Tests สำหรับ Stored Procedures
- End-to-End Tests สำหรับ User Flows ที่สำคัญ
- Load Testing สำหรับการจองพร้อมกัน (Race Condition)

### การตรวจสอบ (Monitoring & Logging)
- บันทึก log สำหรับการดำเนินการที่สำคัญทั้งหมด
- ตั้งค่า alerts สำหรับข้อผิดพลาดและ anomalies
- ติดตามประสิทธิภาพของ database queries
- สร้าง audit trail สำหรับการเปลี่ยนแปลงข้อมูลสำคัญ
